generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  senhaHash String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens RefreshToken[]
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  hashed    String
  userAgent String?
  ip        String?
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user Usuario @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

enum TipoMovimento {
  ENTRADA
  SAIDA
  AJUSTE_POSITIVO
  AJUSTE_NEGATIVO
  TRANSFERENCIA_SAIDA
  TRANSFERENCIA_ENTRADA
  PERDA
  PRODUCAO_CONSUMO
  PRODUCAO_GERACAO
}

model Unidade {
  id        String   @id @default(cuid())
  codigo    String   @unique // "kg","g","L","ml","un"
  nome      String
  fatorBase Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Back-relations (obrigat√≥rios pq h√° m√∫ltiplas rela√ß√µes com Unidade)
  conversoesDe   ConversaoUnidade[] @relation("de")
  conversoesPara ConversaoUnidade[] @relation("para")
  insumosBase    Insumo[]           @relation("InsumoUnidadeBase")
}

model Insumo {
  id            String   @id @default(cuid())
  nome          String
  sku           String?  @unique
  unidadeBaseId String
  unidadeBase   Unidade  @relation("InsumoUnidadeBase", fields: [unidadeBaseId], references: [id])
  ativo         Boolean  @default(true)
  estoqueMinimo Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lotes             Lote[]
  movimentos        MovimentoEstoque[]
  // ‚¨áÔ∏è back-relation para PedidoCompraItem.insumo
  pedidoCompraItens PedidoCompraItem[]
}

model ConversaoUnidade {
  id     String @id @default(cuid())
  deId   String
  paraId String

  de   Unidade @relation("de", fields: [deId], references: [id]) // <- aqui tava "ded"
  para Unidade @relation("para", fields: [paraId], references: [id])

  fator Float
}

model Deposito {
  id        String   @id @default(cuid())
  nome      String   @unique
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  movimentos        MovimentoEstoque[]
  lotes             Lote[]
  // ‚¨áÔ∏è back-relation para PedidoCompraItem.deposito
  pedidoCompraItens PedidoCompraItem[]
}

model Lote {
  id         String    @id @default(cuid())
  insumoId   String
  depositoId String
  codigo     String?
  validade   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  insumo     Insumo             @relation(fields: [insumoId], references: [id])
  deposito   Deposito           @relation(fields: [depositoId], references: [id])
  movimentos MovimentoEstoque[]
}

model MovimentoEstoque {
  id             String        @id @default(cuid())
  insumoId       String
  depositoId     String
  loteId         String?
  tipo           TipoMovimento
  quantidadeBase Float
  custoUnitario  Decimal?      @db.Decimal(14, 4) // MySQL
  documentoRef   String?
  observacao     String?
  createdAt      DateTime      @default(now())

  insumo   Insumo   @relation(fields: [insumoId], references: [id])
  deposito Deposito @relation(fields: [depositoId], references: [id])
  lote     Lote?    @relation(fields: [loteId], references: [id])

  @@index([insumoId, depositoId])
  @@index([loteId])
  @@index([createdAt])
}

model PedidoCompra {
  id         String   @id @default(cuid())
  numero     String   @unique
  fornecedor String?
  status     String   @default("ABERTO") // ABERTO, RECEBIDO, CANCELADO
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  itens PedidoCompraItem[]
}

model PedidoCompraItem {
  id             String    @id @default(cuid())
  pedidoCompraId String
  insumoId       String
  quantidadeBase Float
  custoUnitario  Decimal   @db.Decimal(14, 4)
  depositoId     String
  loteCodigo     String?
  validade       DateTime?

  pedidoCompra PedidoCompra @relation(fields: [pedidoCompraId], references: [id])
  insumo       Insumo       @relation(fields: [insumoId], references: [id])
  deposito     Deposito     @relation(fields: [depositoId], references: [id])

  @@index([pedidoCompraId])
  @@index([insumoId])
  @@index([depositoId])
}

enum Tamanho {
  P
  M
  G
}

model Media {
  id        String   @id @default(cuid())
  filename  String
  path      String   @unique
  mimeType  String
  sizeBytes Int
  createdAt DateTime @default(now())

  produtos Produto[]
}

model CategoriaCardapio {
  id        String   @id @default(cuid())
  nome      String
  slug      String   @unique
  ordem     Int      @default(0)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  produtos Produto[]

  @@unique([nome])
  @@index([ativo])
  @@index([ordem])
}

model Produto {
  id               String   @id @default(cuid())
  nome             String
  descricao        String?
  categoriaId      String
  precoCusto       Decimal? @db.Decimal(14, 2)
  precoVenda       Decimal  @db.Decimal(14, 2)
  ativo            Boolean  @default(true)
  exibirNoCardapio Boolean  @default(true)
  imageId          String?
  imagemUrl        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Rela√ß√µes existentes
  categoria  CategoriaCardapio  @relation(fields: [categoriaId], references: [id])
  image      Media?             @relation(fields: [imageId], references: [id])
  tamanhos   ProdutoTamanho[]
  adicionais ProdutoAdicional[]

  // üëá back-relation que estava faltando
  pedidoItens PedidoItem[] // <‚Äî ADICIONE ESTA LINHA

  @@index([categoriaId])
  @@index([ativo, exibirNoCardapio])
  @@index([createdAt])
}

// Varia√ß√£o de tamanho por produto (P/M/G) com acr√©scimo sobre o precoVenda
model ProdutoTamanho {
  id        String  @id @default(cuid())
  produtoId String
  tamanho   Tamanho
  acrescimo Decimal @default(0) @db.Decimal(14, 2)

  produto Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@unique([produtoId, tamanho]) // um tamanho por produto
  @@index([produtoId])
}

// Adicionais espec√≠ficos do produto (nome + pre√ßo do adicional)
model ProdutoAdicional {
  id        String  @id @default(cuid())
  produtoId String
  nome      String
  preco     Decimal @db.Decimal(14, 2)
  ativo     Boolean @default(true)

  produto Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@unique([produtoId, nome]) // evita duplicar ‚ÄúQueijo extra‚Äù no mesmo produto
  @@index([produtoId, ativo])
}

enum PedidoStatus {
  RECEBIDO
  PREPARO
  PRONTO
  ENTREGUE
  CANCELADO
}

enum FormaPagamento {
  DINHEIRO
  PIX
  CARTAO_CREDITO
  CARTAO_DEBITO
}

model Pedido {
  id          String       @id @default(cuid())
  numero      Int          @unique @default(autoincrement())
  mesa        String
  observacoes String?
  status      PedidoStatus @default(RECEBIDO)

  total       Decimal      @db.Decimal(14, 2)

  // üëá novo campo
  formaPagamento FormaPagamento?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  itens PedidoItem[]

  @@index([status, createdAt])
  @@index([formaPagamento]) // (opcional) √∫til para relat√≥rios por forma
}


/**
 * Itens do pedido com "snapshot" de pre√ßo e nome.
 * Mantemos uma FK opcional para Produto (para rastreabilidade),
 * mas o c√°lculo/vis√£o usa os campos "nome" e "precoUnit" salvos no momento da venda.
 */
model PedidoItem {
  id       String @id @default(cuid())
  pedidoId String
  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  produtoId String?
  produto   Produto? @relation(fields: [produtoId], references: [id]) // ok

  nome       String
  tamanho    Tamanho?
  quantidade Int      @default(1)
  precoUnit  Decimal  @db.Decimal(14, 2)
  obs        String?

  adicionais PedidoItemAdicional[]

  @@index([pedidoId])
  @@index([produtoId])
}

/**
 * Adicionais do item ‚Äì tamb√©m como snapshot (nome + pre√ßo).
 * N√£o referencia ProdutoAdicional para n√£o ‚Äúquebrar‚Äù hist√≥rico se o produto ou adicionais mudarem.
 */
model PedidoItemAdicional {
  id String @id @default(cuid())

  itemId String
  item   PedidoItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  nome  String
  preco Decimal @db.Decimal(14, 2)

  @@index([itemId])
}
